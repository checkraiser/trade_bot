<!DOCTYPE>
<html>
  <head>
    <title>MtGox real time lag indicator</title>
    <script src="https://www.mtgox.com/js/pubnub.min.js"></script>
    <script>
      var global_offset = 0;
      var publish_key   = 'demo'
      var subscribe_key = 'sub-c-50d56e1e-2fd9-11e3-a041-02ee2ddab7fe';

      // trade.lag from http://mtgox.com/api/2/stream/list_public?pretty
      var channel       = '85174711-be64-4de1-b783-0628995d7914';

      (function(){
        window.pubnub = PUBNUB.init({
          publish_key: publish_key,
          subscribe_key: subscribe_key,
          ssl: true
        });

        window.pubnub.subscribe({
          channel: channel,
          message: function(m) {
            document.getElementById('lag_show').innerHTML = (m.lag.age / 1000000).toFixed(6);

            var c_now = Date.now();
            var s_now = Math.floor(m.lag.now / 1000);

            if (global_offset == 0) global_offset = c_now - s_now;

            if (s_now > (c_now - global_offset)) {
              global_offset = c_now - s_now; // adjust offset
            }

            c_now -= global_offset;
            document.getElementById('lag_transit').innerHTML = (c_now - s_now);
          },
          presence: function(d) {
            document.getElementById('lag_occupancy').innerHTML = d.occupancy;
          }
        });
      })();
    </script>
  </head>
  <body>
    <p>Trade engine lag on MtGox: <span id="lag_show">?.??????</span></p>
    <p>Subscribers to this pubnub feed: <span id="lag_occupancy">0</span></p>
    <p>Time taken for transmission to be received: ~<span id="lag_transit">0</span>ms</p>
  </body>
</html>
